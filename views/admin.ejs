<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>后台管理 - 零度小铺</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<%- include('partials/header') %>
<div class="container">
  <h2>后台管理</h2>
  <div class="admin-tabs">
    <a href="/admin" class="<%= tab==='products' ? 'active' : '' %>">商品管理</a>
    <a href="/admin?tab=orders" class="<%= tab==='orders' ? 'active' : '' %>">订单管理</a>
    <a href="/admin?tab=users" class="<%= tab==='users' ? 'active' : '' %>">用户管理</a>
    <a href="/admin?tab=payment" class="<%= tab==='payment' ? 'active' : '' %>">支付设置</a>
    <a href="/admin?tab=cards" class="<%= tab==='cards' ? 'active' : '' %>">卡密管理</a>
    <a href="/admin?tab=site" class="<%= tab==='site' ? 'active' : '' %>">网站设置</a>
  </div>

  <% if(tab === 'products') { %>
  <div class="admin-section">
    <h3>添加商品</h3>
    <form method="post" action="/admin/products/add" class="admin-form">
      <input type="text" name="name" placeholder="商品名称" required>
      <input type="text" name="category" placeholder="分类（Twitter/Instagram等）" required>
      <input type="number" name="price" placeholder="价格" step="0.01" required>
      <input type="number" name="stock" placeholder="库存" required>
      <textarea name="description" placeholder="商品描述"></textarea>
      <input type="text" name="image" placeholder="图片URL（可选）">
      <select name="delivery_type">
        <option value="manual">手动发货</option>
        <option value="card">卡密自动发货</option>
        <option value="link">链接自动发货</option>
      </select>
      <input type="text" name="delivery_content" placeholder="发货链接（链接类型填写）">
      <button type="submit" class="btn-buy">添加</button>
    </form>
    <h3>商品列表</h3>
    <table class="cart-table">
      <thead><tr><th>ID</th><th>名称</th><th>分类</th><th>价格</th><th>库存</th><th>状态</th><th>操作</th></tr></thead>
      <tbody>
      <% products.forEach(p => { %>
      <tr>
        <td><%= p.id %></td>
        <td><%= p.name %></td>
        <td><%= p.category %></td>
        <td>¥<%= p.price.toFixed(2) %></td>
        <td><%= p.stock %></td>
        <td><%= p.status ? '上架' : '下架' %></td>
        <td>
          <form method="post" action="/admin/products/toggle" style="display:inline">
            <input type="hidden" name="id" value="<%= p.id %>">
            <button type="submit" class="btn-sm"><%= p.status ? '下架' : '上架' %></button>
          </form>
          <form method="post" action="/admin/products/delete" style="display:inline" onsubmit="return confirm('确认删除？')">
            <input type="hidden" name="id" value="<%= p.id %>">
            <button type="submit" class="btn-del">删除</button>
          </form>
        </td>
      </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <% } else if(tab === 'orders') { %>
  <div class="admin-section">
    <h3>订单列表</h3>
    <table class="cart-table">
      <thead><tr><th>ID</th><th>用户</th><th>金额</th><th>状态</th><th>联系</th><th>时间</th><th>操作</th></tr></thead>
      <tbody>
      <% orders.forEach(o => { %>
      <tr>
        <td>#<%= o.id %></td>
        <td><%= o.username %></td>
        <td>¥<%= o.total.toFixed(2) %></td>
        <td><span class="status-<%= o.status %>"><%= {pending:'待处理',processing:'处理中',completed:'已完成',cancelled:'已取消'}[o.status] || o.status %></span></td>
        <td><%= o.contact %></td>
        <td><%= o.created_at %></td>
        <td>
          <form method="post" action="/admin/orders/status" style="display:inline">
            <input type="hidden" name="id" value="<%= o.id %>">
            <select name="status" onchange="this.form.submit()">
              <option value="pending" <%= o.status==='pending'?'selected':'' %>>待处理</option>
              <option value="processing" <%= o.status==='processing'?'selected':'' %>>处理中</option>
              <option value="completed" <%= o.status==='completed'?'selected':'' %>>已完成</option>
              <option value="cancelled" <%= o.status==='cancelled'?'selected':'' %>>已取消</option>
            </select>
          </form>
        </td>
      </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <% } else if(tab === 'users') { %>
  <div class="admin-section">
    <h3>用户列表</h3>
    <table class="cart-table">
      <thead><tr><th>ID</th><th>用户名</th><th>邮箱</th><th>角色</th><th>注册时间</th></tr></thead>
      <tbody>
      <% users.forEach(u => { %>
      <tr>
        <td><%= u.id %></td>
        <td><%= u.username %></td>
        <td><%= u.email || '-' %></td>
        <td><%= u.role %></td>
        <td><%= u.created_at %></td>
      </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <% } else if(tab === 'payment') { %>
  <div class="admin-section">
    <h3>添加收款钱包</h3>
    <form method="post" action="/admin/wallets/add" class="admin-form">
      <select name="chain" required>
        <option value="">选择链</option>
        <option value="ETH">ETH（以太坊）</option>
        <option value="BSC">BSC（币安链）</option>
        <option value="TRX">TRX（波场）</option>
        <option value="SOL">SOL（Solana）</option>
      </select>
      <select name="symbol" required>
        <option value="">选择币种</option>
        <option value="USDT">USDT</option>
        <option value="USDC">USDC</option>
      </select>
      <input type="text" name="address" placeholder="收款钱包地址" required>
      <input type="text" name="label" placeholder="备注（可选）">
      <button type="submit" class="btn-buy">添加</button>
    </form>

    <h3>钱包列表</h3>
    <table class="cart-table">
      <thead><tr><th>链</th><th>币种</th><th>地址</th><th>备注</th><th>状态</th><th>操作</th></tr></thead>
      <tbody>
      <% wallets.forEach(w => { %>
      <tr>
        <td><%= w.chain %></td>
        <td><%= w.symbol %></td>
        <td style="font-size:12px;word-break:break-all"><%= w.address %></td>
        <td><%= w.label || '-' %></td>
        <td><%= w.enabled ? '启用' : '禁用' %></td>
        <td>
          <form method="post" action="/admin/wallets/toggle" style="display:inline">
            <input type="hidden" name="id" value="<%= w.id %>">
            <button type="submit" class="btn-sm"><%= w.enabled ? '禁用' : '启用' %></button>
          </form>
          <form method="post" action="/admin/wallets/delete" style="display:inline" onsubmit="return confirm('确认删除？')">
            <input type="hidden" name="id" value="<%= w.id %>">
            <button type="submit" class="btn-del">删除</button>
          </form>
        </td>
      </tr>
      <% }) %>
      </tbody>
    </table>

    <h3>待确认支付</h3>
    <table class="cart-table">
      <thead><tr><th>订单</th><th>链</th><th>USD</th><th>USDT</th><th>收款地址</th><th>时间</th><th>操作</th></tr></thead>
      <tbody>
      <% cryptoOrders.forEach(co => { %>
      <tr>
        <td>#<%= co.order_id %></td>
        <td><%= co.chain %>/<%= co.symbol %></td>
        <td>$<%= co.amount_usd.toFixed(2) %></td>
        <td><%= co.amount_crypto.toFixed(2) %></td>
        <td style="font-size:12px;word-break:break-all"><%= co.wallet_address %></td>
        <td><%= co.created_at %></td>
        <td>
          <% if(co.status === 'pending' || co.status === 'confirming') { %>
          <form method="post" action="/admin/crypto/confirm" style="display:inline">
            <input type="hidden" name="crypto_order_id" value="<%= co.id %>">
            <input type="text" name="tx_hash" placeholder="交易哈希（可选）" style="width:120px;font-size:12px">
            <button type="submit" class="btn-buy" style="padding:4px 8px">确认收款</button>
          </form>
          <% } else { %>
          <span><%= co.status === 'paid' ? '✅已收款' : co.status %></span>
          <% } %>
        </td>
      </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <% } else if(tab === 'cards') { %>
  <div class="admin-section">
    <h3>批量导入卡密</h3>
    <form method="post" action="/admin/cards/import" class="admin-form">
      <select name="product_id" required>
        <option value="">选择商品</option>
        <% products.forEach(p => { %>
        <option value="<%= p.id %>"><%= p.name %></option>
        <% }) %>
      </select>
      <textarea name="cards" rows="8" placeholder="每行一条卡密，批量粘贴" required></textarea>
      <button type="submit" class="btn-buy">批量导入</button>
    </form>
    <h3>卡密库存统计</h3>
    <table class="cart-table">
      <thead><tr><th>商品</th><th>总数</th><th>已用</th><th>剩余</th></tr></thead>
      <tbody>
      <% cardStats.forEach(s => { %>
      <tr>
        <td><%= s.name %></td>
        <td><%= s.total %></td>
        <td><%= s.used %></td>
        <td><%= s.remaining %></td>
      </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <% } else if(tab === 'site') { %>
  <div class="admin-section">
    <h3>网站设置</h3>
    <form method="post" action="/admin/site/save" class="admin-form">
      <label>网站名称</label>
      <input type="text" name="site_name" value="<%= settings.site_name %>" required>
      <label>网站标语</label>
      <input type="text" name="site_slogan" value="<%= settings.site_slogan %>">
      <label>底部声明</label>
      <input type="text" name="footer_notice" value="<%= settings.footer_notice %>">
      <label>退款政策</label>
      <input type="text" name="refund_policy" value="<%= settings.refund_policy %>">
      <label>Telegram 客服（如 @xman）</label>
      <input type="text" name="contact_telegram" value="<%= settings.contact_telegram %>">
      <label>工作时间</label>
      <input type="text" name="contact_hours" value="<%= settings.contact_hours %>">
      <label>版权信息</label>
      <input type="text" name="copyright" value="<%= settings.copyright %>">
      <button type="submit" class="btn-buy">保存</button>
    </form>
  </div>
  <% } %>
</div>
<%- include('partials/footer') %>
</body>
</html>
